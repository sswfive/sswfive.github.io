<!DOCTYPE html>
<html lang="en">
    
    <head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="å‚¨å­˜ç»„ä»¶Longhornéƒ¨ç½²ä½¿ç”¨" />
    <meta name="hexo-theme-A4" content="v1.9.7" />
    <link rel="alternate icon" type="image/webp" href="/images/head.png">
    <title>WSShen</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


<meta name="generator" content="Hexo 7.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>
    
    

    
    



    

    
    

    
    
    
    <!-- æ·»åŠ å…¨å±€æœç´¢ç›¸å…³çš„æ ·å¼å’Œè„šæœ¬ -->
    <link rel="stylesheet" href="/css/custom.css">
    <script src="/js/custom-search.js"></script>
    
    <body>
        <!-- hexo-inject:begin --><!-- hexo-inject:end --><script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 0; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/images/head.png" 
        />
        <div class="header-content">
            <a class="logo" href="/">WSShen</a> 
            <span class="description"></span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/about/">å…³äº</a></li>
            
        
            
                <li><a href="/tags/">æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">åˆ†ç±»</a></li>
            
        
            
                <li><a href="/search/">æœç´¢</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    å‚¨å­˜ç»„ä»¶Longhornéƒ¨ç½²ä½¿ç”¨
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2025-03-17</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š5.7k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š31åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="post-toc-text">æ¦‚è¿°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="post-toc-text">å®‰è£…éƒ¨ç½²</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="post-toc-text">å‰ææ¡ä»¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B"><span class="post-toc-text">ç¯å¢ƒæ£€æµ‹</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85"><span class="post-toc-text">å®‰è£…</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="post-toc-text">éƒ¨ç½²</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%9F%A5%E7%9C%8B"><span class="post-toc-text">æŸ¥çœ‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%B5%8B%E8%AF%95%E5%AE%89%E8%A3%85"><span class="post-toc-text">æµ‹è¯•å®‰è£…</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AF%B4%E6%98%8E"><span class="post-toc-text">æµ‹è¯•è¯´æ˜</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="post-toc-text">å‚æ•°è§£æ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BA%86%E8%A7%A3%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="post-toc-text">äº†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„ç»“æœ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2-FIO-%E5%9F%BA%E5%87%86"><span class="post-toc-text">éƒ¨ç½² FIO åŸºå‡†</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%9C%A8-Kubernetes-%E9%9B%86%E7%BE%A4%E4%B8%AD%E9%83%A8%E7%BD%B2%E5%8D%95%E5%8D%B7%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="post-toc-text">åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å•å·åŸºå‡†æµ‹è¯•</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B5%8B%E8%AF%95%E6%AD%A5%E9%AA%A4"><span class="post-toc-text">æµ‹è¯•æ­¥éª¤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Longhorn%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="post-toc-text">LonghornåŸºå‡†æµ‹è¯•</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="post-toc-text">ç»“æœå±•ç¤º</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%B8%E8%BD%BD%E6%AD%A5%E9%AA%A4"><span class="post-toc-text">å¸è½½æ­¥éª¤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%A0%E9%99%A4%E6%A0%87%E5%BF%97%E8%AE%BE%E7%BD%AE%EF%BC%9A%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%8C%E7%BB%88%E7%AB%AF"><span class="post-toc-text">åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼ä¸€ï¼Œç»ˆç«¯</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%A0%E9%99%A4%E6%A0%87%E5%BF%97%E8%AE%BE%E7%BD%AE%EF%BC%9A%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%8C%E7%95%8C%E9%9D%A2"><span class="post-toc-text">åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼äºŒï¼Œç•Œé¢</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C"><span class="post-toc-text">åˆ é™¤æ“ä½œ</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#FAQ"><span class="post-toc-text">FAQ</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85iscsi-initiator-utils%E6%8A%A5%E9%94%99"><span class="post-toc-text">å®‰è£…iscsi-initiator-utilsæŠ¥é”™</span></a></li></ol>
            
        
        <div class=".article-gallery"><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Longhornæ˜¯åŸºäºKuberneteså’ŒContainerçš„æ„å»ºçš„åˆ†å¸ƒå¼å—å­˜å‚¨ç³»ç»Ÿï¼Œè½»é‡ã€å¯é ä¸”åŠŸèƒ½å¼ºå¤§ï¼Œ Longhornä¸ºæ¯ä¸ªå—è®¾å¤‡å·åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„å­˜å‚¨æ§åˆ¶å™¨ï¼Œå¹¶ä¸”å¯¹å¤šä¸ªèŠ‚ç‚¹ä¸Šå­˜å‚¨å‰¯æœ¬ä¸­çš„å·è¿›è¡Œå®æ—¶å¤åˆ¶ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„ä¸»è¦ç‰¹ç‚¹ï¼š</p>
<ul>
<li>Longhornçš„å·å¯ä»¥ä½œä¸ºKubernetesé›†ç¾¤ä¸­åˆ†å¸ƒå¼æœ‰çŠ¶æ€åº”ç”¨çš„å­˜å‚¨ã€‚</li>
<li>å¯ä»¥å°†å—å­˜å‚¨åˆ’åˆ†ä¸ºLonghornå·ï¼Œä»¥ä¾¿åœ¨æœ‰æˆ–æ²¡æœ‰äº‘æä¾›å•†çš„æƒ…å†µä¸‹ä½¿ç”¨Kuberneteså·ã€‚</li>
<li>å¯ä»¥è·¨èŠ‚ç‚¹å’Œæ•°æ®ä¸­å¿ƒå¤åˆ¶å—å­˜å‚¨ï¼Œä»è€Œæé«˜å¯ç”¨æ€§ã€‚</li>
<li>å¯ä»¥åœ¨å¤–éƒ¨å­˜å‚¨ä¸Šå­˜å‚¨å¤‡ä»½æ•°æ®ï¼Œä¾‹å¦‚ï¼šNFSv4æˆ–AWS S3ã€‚</li>
<li>å¯ä»¥åˆ›å»ºè·¨ç¾¤é›†ç¾éš¾æ¢å¤å·ï¼Œä»¥ä¾¿ä»å¤‡ç”¨çš„Kubernetesé›†ç¾¤çš„å¤‡ä»½ä¸­å¿«é€Ÿæ¢å¤æ¥è‡ªä¸»Kubernetesç¾¤é›†çš„æ•°æ®ã€‚</li>
<li>å¯ä»¥ä¸ºå·è®¾ç½®è®¡åˆ’ï¼Œå¯¹å·å®šæœŸç”Ÿæˆå¿«ç…§ï¼Œå¹¶æŠŠå¿«ç…§å¤‡ä»½åˆ°NFSæˆ–è€…å…¼å®¹S3çš„å¤‡ç”¨å­˜å‚¨ä¸­ã€‚</li>
<li>æ”¯æŒä»å¤‡ä»½ä¸­æ¢å¤å·ã€‚</li>
<li>æ”¯æŒä¸ä¸­æ–­å·æœåŠ¡çš„æƒ…å†µä¸‹è¿›è¡Œå‡çº§ã€‚</li>
</ul>
<p>é¡¹ç›®ä¿¡æ¯ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://longhorn.io/">å®˜æ–¹åœ°å€</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/longhorn/longhorn">Github</a>: å½“å‰é¡¹ç›®ç‰ˆæœ¬V1.7, æ¯”è¾ƒæ´»è·ƒï¼ŒStaræ•°ï¼š5.9kã€Forkæ•°ï¼š585</li>
</ul>
<h2 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h2><h3 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h3><ul>
<li>ä¸€ä¸ªæ­£å¸¸è¿è¡Œçš„Kubernetesé›†ç¾¤</li>
<li>é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹å·²ç»å®‰è£…ä¸‹åˆ—è½¯ä»¶åŒ…ï¼Œå¹¶æ­£å¸¸å¯åŠ¨<ul>
<li>open-iscsiï¼ˆiscsidæœåŠ¡ï¼‰<ul>
<li>å®‰è£…ï¼š yum install iscsi-initiator-utils</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ç¯å¢ƒæ£€æµ‹"><a href="#ç¯å¢ƒæ£€æµ‹" class="headerlink" title="ç¯å¢ƒæ£€æµ‹"></a>ç¯å¢ƒæ£€æµ‹</h3><ul>
<li>å„å­˜å‚¨èŠ‚ç‚¹åˆ›å»ºç›®å½•åŠæŒ‚è½½</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†å­˜å‚¨ç›˜æŒ‚è½½åˆ°/data1æ‰€åœ¨ç›®å½•ï¼Œå¹¶åˆ›å»ºlonghornç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /home/data1/longhorn</span><br></pre></td></tr></table></figure>

<ul>
<li>å­˜å‚¨èŠ‚ç‚¹ä½¿ç”¨å‘½ä»¤æ‰“æ ‡ç­¾ï¼škubectl label nodes node77  node78  node79 node.longhorn.io&#x2F;create-default-disk&#x3D;true</li>
<li>å®‰è£…longhornæ‰€éœ€ç³»ç»Ÿä¾èµ–</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br><span class="line">yum --<span class="built_in">setopt</span>=tsflags=noscripts install iscsi-initiator-utils</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;InitiatorName=<span class="subst">$(/sbin/iscsi-iname)</span>&quot;</span> &gt; /etc/iscsi/initiatorname.iscsi</span><br><span class="line">systemctl <span class="built_in">enable</span> iscsid</span><br><span class="line">systemctl start iscsid</span><br><span class="line"></span><br><span class="line">wget https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 -O /usr/local/bin/jq</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/jq</span><br></pre></td></tr></table></figure>

<ul>
<li>æ–°å»ºlonghorn_check_env.shæ–‡ä»¶ï¼Œå°†ä¸‹åˆ—å†…å®¹æ‹·è´è¿›å…¥ï¼Œä¿å­˜å¹¶æ‰§è¡Œã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">NVME_CLI_VERSION=<span class="string">&quot;1.12&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="built_in">export</span> RED=<span class="string">&#x27;\x1b[0;31m&#x27;</span></span><br><span class="line"><span class="built_in">export</span> GREEN=<span class="string">&#x27;\x1b[38;5;22m&#x27;</span></span><br><span class="line"><span class="built_in">export</span> CYAN=<span class="string">&#x27;\x1b[36m&#x27;</span></span><br><span class="line"><span class="built_in">export</span> YELLOW=<span class="string">&#x27;\x1b[33m&#x27;</span></span><br><span class="line"><span class="built_in">export</span> NO_COLOR=<span class="string">&#x27;\x1b[0m&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;LOG_TITLE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  LOG_TITLE=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  LOG_LEVEL=<span class="string">&quot;INFO&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">debug</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;DEBUG&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">local</span> log_title</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;LOG_TITLE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">     log_title=<span class="string">&quot;(<span class="variable">$&#123;LOG_TITLE&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">     log_title=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>[DEBUG]<span class="variable">$&#123;log_title&#125;</span> <span class="variable">$&#123;NO_COLOR&#125;</span><span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">info</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;DEBUG&quot;</span> ]] ||\</span><br><span class="line">     [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;INFO&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">local</span> log_title</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;LOG_TITLE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">     log_title=<span class="string">&quot;(<span class="variable">$&#123;LOG_TITLE&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">     log_title=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>[INFO] <span class="variable">$&#123;log_title&#125;</span> <span class="variable">$&#123;NO_COLOR&#125;</span><span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">warn</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;DEBUG&quot;</span> ]] ||\</span><br><span class="line">     [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;INFO&quot;</span> ]] ||\</span><br><span class="line">     [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;WARN&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">local</span> log_title</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;LOG_TITLE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">     log_title=<span class="string">&quot;(<span class="variable">$&#123;LOG_TITLE&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">     log_title=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>[WARN] <span class="variable">$&#123;log_title&#125;</span> <span class="variable">$&#123;NO_COLOR&#125;</span><span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">error</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;DEBUG&quot;</span> ]] ||\</span><br><span class="line">     [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;INFO&quot;</span> ]] ||\</span><br><span class="line">     [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;WARN&quot;</span> ]] ||\</span><br><span class="line">     [[ <span class="string">&quot;<span class="variable">$&#123;LOG_LEVEL&#125;</span>&quot;</span> == <span class="string">&quot;ERROR&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">local</span> log_title</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;LOG_TITLE&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">     log_title=<span class="string">&quot;(<span class="variable">$&#123;LOG_TITLE&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">     log_title=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>[ERROR]<span class="variable">$&#123;log_title&#125;</span> <span class="variable">$&#123;NO_COLOR&#125;</span><span class="variable">$1</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment"># Check logics</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="function"><span class="title">set_packages_and_check_cmd</span></span>() &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$OS</span> <span class="keyword">in</span></span><br><span class="line">  *<span class="string">&quot;debian&quot;</span>* | *<span class="string">&quot;ubuntu&quot;</span>* )</span><br><span class="line">    CHECK_CMD=<span class="string">&#x27;dpkg -l | grep -w&#x27;</span></span><br><span class="line">    PACKAGES=(nfs-common open-iscsi cryptsetup dmsetup)</span><br><span class="line">    ;;</span><br><span class="line">  *<span class="string">&quot;centos&quot;</span>* | *<span class="string">&quot;fedora&quot;</span>* | *<span class="string">&quot;rocky&quot;</span>* | *<span class="string">&quot;ol&quot;</span>* )</span><br><span class="line">    CHECK_CMD=<span class="string">&#x27;rpm -q&#x27;</span></span><br><span class="line">    PACKAGES=(nfs-utils iscsi-initiator-utils cryptsetup device-mapper)</span><br><span class="line">    ;;</span><br><span class="line">  *<span class="string">&quot;suse&quot;</span>* )</span><br><span class="line">    CHECK_CMD=<span class="string">&#x27;rpm -q&#x27;</span></span><br><span class="line">    PACKAGES=(nfs-client open-iscsi cryptsetup device-mapper)</span><br><span class="line">    ;;</span><br><span class="line">  *<span class="string">&quot;arch&quot;</span>* )</span><br><span class="line">    CHECK_CMD=<span class="string">&#x27;pacman -Q&#x27;</span></span><br><span class="line">    PACKAGES=(nfs-utils open-iscsi cryptsetup device-mapper)</span><br><span class="line">    ;;</span><br><span class="line">  *<span class="string">&quot;gentoo&quot;</span>* )</span><br><span class="line">    CHECK_CMD=<span class="string">&#x27;qlist -I&#x27;</span></span><br><span class="line">    PACKAGES=(net-fs/nfs-utils sys-block/open-iscsi sys-fs/cryptsetup sys-fs/lvm2)</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    CHECK_CMD=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    PACKAGES=()</span><br><span class="line">    warn <span class="string">&quot;Stop the environment check because &#x27;<span class="variable">$OS</span>&#x27; is not supported in the environment check script.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br><span class="line">   <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">detect_node_kernel_release</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  KERNEL_RELEASE=$(kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&#x27;uname -r&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$KERNEL_RELEASE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">detect_node_os</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  OS=$(kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&#x27;grep -E &quot;^ID_LIKE=&quot; /etc/os-release | cut -d= -f2&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$&#123;OS&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    OS=$(kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&#x27;grep -E &quot;^ID=&quot; /etc/os-release | cut -d= -f2&#x27;</span>)</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OS</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_local_dependencies</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> targets=(<span class="variable">$@</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> all_found=<span class="literal">true</span></span><br><span class="line">  <span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;<span class="variable">$&#123;#targets[@]&#125;</span>; i++)); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> target=<span class="variable">$&#123;targets[$i]&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$(which $target)</span>&quot;</span> = <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      all_found=<span class="literal">false</span></span><br><span class="line">      error <span class="string">&quot;Not found: <span class="variable">$target</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$all_found</span>&quot;</span> = <span class="string">&quot;false&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    msg=<span class="string">&quot;Please install missing dependencies: <span class="variable">$&#123;targets[@]&#125;</span>.&quot;</span></span><br><span class="line">    info <span class="string">&quot;<span class="variable">$msg</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 2</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  msg=<span class="string">&quot;Required dependencies &#x27;<span class="variable">$&#123;targets[@]&#125;</span>&#x27; are installed.&quot;</span></span><br><span class="line">  info <span class="string">&quot;<span class="variable">$msg</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">create_ds</span></span>() &#123;</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; $TEMP_DIR/environment_check.yaml</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: DaemonSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: longhorn-environment-check</span></span><br><span class="line"><span class="string">  name: longhorn-environment-check</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: longhorn-environment-check</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: longhorn-environment-check</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      hostPID: true</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: longhorn-environment-check</span></span><br><span class="line"><span class="string">        image: alpine:3.12</span></span><br><span class="line"><span class="string">        args: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 1000000000&quot;]</span></span><br><span class="line"><span class="string">        volumeMounts:</span></span><br><span class="line"><span class="string">        - name: mountpoint</span></span><br><span class="line"><span class="string">          mountPath: /tmp/longhorn-environment-check</span></span><br><span class="line"><span class="string">          mountPropagation: Bidirectional</span></span><br><span class="line"><span class="string">        securityContext:</span></span><br><span class="line"><span class="string">          privileged: true</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">      - name: mountpoint</span></span><br><span class="line"><span class="string">        hostPath:</span></span><br><span class="line"><span class="string">            path: /tmp/longhorn-environment-check</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">  kubectl create -f <span class="variable">$TEMP_DIR</span>/environment_check.yaml &gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">  info <span class="string">&quot;Cleaning up longhorn-environment-check pods...&quot;</span></span><br><span class="line">  kubectl delete -f <span class="variable">$TEMP_DIR</span>/environment_check.yaml &gt; /dev/null</span><br><span class="line">  <span class="built_in">rm</span> -rf <span class="variable">$TEMP_DIR</span></span><br><span class="line">  info <span class="string">&quot;Cleanup completed.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">wait_ds_ready</span></span>() &#123;</span><br><span class="line">  <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> ds=$(kubectl get ds/longhorn-environment-check -o json)</span><br><span class="line">    <span class="built_in">local</span> numberReady=$(<span class="built_in">echo</span> <span class="variable">$ds</span> | jq .status.numberReady)</span><br><span class="line">    <span class="built_in">local</span> desiredNumberScheduled=$(<span class="built_in">echo</span> <span class="variable">$ds</span> | jq .status.desiredNumberScheduled)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$desiredNumberScheduled</span>&quot;</span> = <span class="string">&quot;<span class="variable">$numberReady</span>&quot;</span> ] &amp;&amp; [ <span class="string">&quot;<span class="variable">$desiredNumberScheduled</span>&quot;</span> != <span class="string">&quot;0&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      info <span class="string">&quot;All longhorn-environment-check pods are ready (<span class="variable">$numberReady</span>/<span class="variable">$desiredNumberScheduled</span>).&quot;</span></span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    info <span class="string">&quot;Waiting for longhorn-environment-check pods to become ready (<span class="variable">$numberReady</span>/<span class="variable">$desiredNumberScheduled</span>)...&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_mount_propagation</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> allSupported=<span class="literal">true</span></span><br><span class="line">  <span class="built_in">local</span> pods=$(kubectl -l app=longhorn-environment-check get po -o json)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> ds=$(kubectl get ds/longhorn-environment-check -o json)</span><br><span class="line">  <span class="built_in">local</span> desiredNumberScheduled=$(<span class="built_in">echo</span> <span class="variable">$ds</span> | jq .status.desiredNumberScheduled)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;desiredNumberScheduled; i++)); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> pod=$(<span class="built_in">echo</span> <span class="variable">$pods</span> | jq .items[<span class="variable">$i</span>])</span><br><span class="line">    <span class="built_in">local</span> nodeName=$(<span class="built_in">echo</span> <span class="variable">$pod</span> | jq -r .spec.nodeName)</span><br><span class="line">    <span class="built_in">local</span> mountPropagation=$(<span class="built_in">echo</span> <span class="variable">$pod</span> | jq -r <span class="string">&#x27;.spec.containers[0].volumeMounts[] | select(.name==&quot;mountpoint&quot;) | .mountPropagation&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$mountPropagation</span>&quot;</span> != <span class="string">&quot;Bidirectional&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      allSupported=<span class="literal">false</span></span><br><span class="line">      error <span class="string">&quot;node <span class="variable">$nodeName</span>: MountPropagation is disabled&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$allSupported</span>&quot;</span> != <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;MountPropagation is disabled on at least one node. As a result, CSI driver and Base image cannot be supported&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    info <span class="string">&quot;MountPropagation is enabled&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_hostname_uniqueness</span></span>() &#123;</span><br><span class="line">  hostnames=$(kubectl get nodes -o jsonpath=<span class="string">&#x27;&#123;.items[*].status.addresses[?(@.type==&quot;Hostname&quot;)].address&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;kubectl get nodes failed - check KUBECONFIG setup&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [[ ! <span class="variable">$&#123;hostnames[@]&#125;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;kubectl get nodes returned empty list - check KUBECONFIG setup&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  deduplicate_hostnames=()</span><br><span class="line">  num_nodes=0</span><br><span class="line">  <span class="keyword">for</span> hostname <span class="keyword">in</span> <span class="variable">$&#123;hostnames&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    num_nodes=$((num_nodes+<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;deduplicate_hostnames[@]&#125;</span>&quot;</span> | grep -q <span class="string">&quot;\&lt;<span class="variable">$&#123;hostname&#125;</span>\&gt;&quot;</span>; <span class="keyword">then</span></span><br><span class="line">      deduplicate_hostnames+=(<span class="string">&quot;<span class="variable">$&#123;hostname&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;#deduplicate_hostnames[@]&#125;</span>&quot;</span> != <span class="string">&quot;<span class="variable">$&#123;num_nodes&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;Nodes do not have unique hostnames.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 2</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  info <span class="string">&quot;All nodes have unique hostnames.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_nodes</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> name=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> callback=<span class="variable">$2</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line">  info <span class="string">&quot;Checking <span class="variable">$name</span>...&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> all_passed=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> pods=$(kubectl get pods -o name -l app=longhorn-environment-check)</span><br><span class="line">  <span class="keyword">for</span> pod <span class="keyword">in</span> <span class="variable">$&#123;pods&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$&#123;callback&#125;</span> <span class="variable">$&#123;pod&#125;</span> <span class="variable">$@</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      all_passed=<span class="literal">false</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$all_passed</span>&quot;</span> = <span class="string">&quot;false&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">verlte</span></span>() &#123;</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span> | <span class="built_in">sort</span> -C -V</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">verlt</span></span>() &#123;</span><br><span class="line">    ! verlte <span class="string">&quot;<span class="variable">$2</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">kernel_in_range</span></span>() &#123;</span><br><span class="line">    verlte <span class="string">&quot;<span class="variable">$2</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> &amp;&amp; verlt <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_kernel_release</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line"></span><br><span class="line">  recommended_kernel_release=<span class="string">&quot;5.8&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> kernel=$(detect_node_kernel_release <span class="variable">$&#123;pod&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> verlt <span class="string">&quot;<span class="variable">$kernel</span>&quot;</span> <span class="string">&quot;<span class="variable">$recommended_kernel_release</span>&quot;</span>  ; <span class="keyword">then</span></span><br><span class="line">    warn <span class="string">&quot;Node <span class="variable">$node</span> has outdated kernel release: <span class="variable">$kernel</span>. Recommending kernel release &gt;= <span class="variable">$recommended_kernel_release</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> broken_kernel=(<span class="string">&quot;5.15.0-94&quot;</span> <span class="string">&quot;6.5.6&quot;</span>)</span><br><span class="line">  <span class="built_in">local</span> fixed_kernel=(<span class="string">&quot;5.15.0-100&quot;</span> <span class="string">&quot;6.5.7&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;!broken_kernel[@]&#125;</span>; <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">if</span> kernel_in_range <span class="string">&quot;<span class="variable">$kernel</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;broken_kernel[$i]&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;fixed_kernel[$i]&#125;</span>&quot;</span> ; <span class="keyword">then</span></span><br><span class="line">        warn <span class="string">&quot;Node <span class="variable">$node</span> has a kernel version <span class="variable">$kernel</span> known to have a breakage that affects Longhorn. See description and solution at https://longhorn.io/kb/troubleshooting-rwx-volume-fails-to-attached-caused-by-protocol-not-supported&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_iscsid</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">  kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;systemctl status --no-pager iscsid.service&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;systemctl status --no-pager iscsid.socket&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">      <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line">      error <span class="string">&quot;Neither iscsid.service nor iscsid.socket is running on <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_multipathd</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">  kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;systemctl status --no-pager multipathd.service&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  <span class="keyword">if</span> [ $? = 0 ]; <span class="keyword">then</span></span><br><span class="line">    node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line">    warn <span class="string">&quot;multipathd is running on <span class="variable">$&#123;node&#125;</span> known to have a breakage that affects Longhorn.  See description and solution at https://longhorn.io/kb/troubleshooting-volume-with-multipath&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_packages</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">  OS=$(detect_node_os <span class="variable">$&#123;pod&#125;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ x<span class="string">&quot;<span class="variable">$OS</span>&quot;</span> = x<span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;Failed to detect OS on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  set_packages_and_check_cmd</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;<span class="variable">$&#123;#PACKAGES[@]&#125;</span>; i++)); <span class="keyword">do</span></span><br><span class="line">    check_package <span class="variable">$&#123;PACKAGES[$i]&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_package</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> package=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">  kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- <span class="built_in">timeout</span> 30 bash -c <span class="string">&quot;<span class="variable">$CHECK_CMD</span> <span class="variable">$package</span>&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line">    error <span class="string">&quot;<span class="variable">$package</span> is not found in <span class="variable">$node</span>.&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_nfs_client</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> options=(<span class="string">&quot;CONFIG_NFS_V4_2&quot;</span>  <span class="string">&quot;CONFIG_NFS_V4_1&quot;</span> <span class="string">&quot;CONFIG_NFS_V4&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> kernel=$(detect_node_kernel_release <span class="variable">$&#123;pod&#125;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$&#123;kernel&#125;</span>&quot;</span> = <span class="string">&quot;x&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    warn <span class="string">&quot;Failed to check NFS client installation, because unable to detect kernel release on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> option <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;options[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;[ -f /boot/config-<span class="variable">$&#123;kernel&#125;</span> ]&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      warn <span class="string">&quot;Failed to check <span class="variable">$option</span> on node <span class="variable">$&#123;node&#125;</span>, because /boot/config-<span class="variable">$&#123;kernel&#125;</span> does not exist on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">      <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    check_kernel_module <span class="variable">$&#123;pod&#125;</span> <span class="variable">$&#123;option&#125;</span> nfs</span><br><span class="line">    <span class="keyword">if</span> [ $? = 0 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  error <span class="string">&quot;NFS clients <span class="variable">$&#123;options[*]&#125;</span> not found. At least one should be enabled&quot;</span></span><br><span class="line">  <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_kernel_module</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> option=<span class="variable">$2</span></span><br><span class="line">  <span class="built_in">local</span> module=<span class="variable">$3</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> kernel=$(detect_node_kernel_release <span class="variable">$&#123;pod&#125;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$&#123;kernel&#125;</span>&quot;</span> = <span class="string">&quot;x&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    warn <span class="string">&quot;Failed to check kernel config option <span class="variable">$&#123;option&#125;</span>, because unable to detect kernel release on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;[ -e /boot/config-<span class="variable">$&#123;kernel&#125;</span> ]&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    warn <span class="string">&quot;Failed to check kernel config option <span class="variable">$&#123;option&#125;</span>, because /boot/config-<span class="variable">$&#123;kernel&#125;</span> does not exist on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  value=$(kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;grep &quot;</span>^<span class="variable">$option</span>=<span class="string">&quot; /boot/config-<span class="variable">$&#123;kernel&#125;</span> | cut -d= -f2&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;value&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;Failed to find kernel config <span class="variable">$option</span> on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;value&#125;</span>&quot;</span> = <span class="string">&quot;m&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&quot;lsmod | grep <span class="variable">$&#123;module&#125;</span>&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line">      error <span class="string">&quot;kernel module <span class="variable">$&#123;module&#125;</span> is not enabled on <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;value&#125;</span>&quot;</span> = <span class="string">&quot;y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    warn <span class="string">&quot;Unknown value for <span class="variable">$option</span>: <span class="variable">$value</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_hugepage</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> expected_nr_hugepages=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">  nr_hugepages=$(kubectl <span class="built_in">exec</span> <span class="variable">$&#123;pod&#125;</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&#x27;cat /proc/sys/vm/nr_hugepages&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;Failed to check hugepage size on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$nr_hugepages</span> -lt <span class="variable">$expected_nr_hugepages</span> ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;Hugepage size is not enough on node <span class="variable">$&#123;node&#125;</span>. Expected: <span class="variable">$&#123;expected_nr_hugepages&#125;</span>, Actual: <span class="variable">$&#123;nr_hugepages&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">check_sse42_support</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> pod=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">  node=$(kubectl get <span class="variable">$&#123;pod&#125;</span> --no-headers -o=custom-columns=:.spec.nodeName)</span><br><span class="line"></span><br><span class="line">  machine=$(kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&#x27;uname -m&#x27;</span> 2&gt;/dev/null)</span><br><span class="line">  <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    error <span class="string">&quot;Failed to check machine on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$machine</span>&quot;</span> = <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    sse42_support=$(kubectl <span class="built_in">exec</span> <span class="variable">$pod</span> -- nsenter --mount=/proc/1/ns/mnt -- bash -c <span class="string">&#x27;grep -o sse4_2 /proc/cpuinfo | wc -l&#x27;</span> 2&gt;/dev/null)</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      error <span class="string">&quot;Failed to check SSE4.2 instruction set on node <span class="variable">$&#123;node&#125;</span>&quot;</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$sse42_support</span>&quot;</span> -ge 1 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    error <span class="string">&quot;CPU does not support SSE4.2&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    warn <span class="string">&quot;Skip SSE4.2 instruction set check on node <span class="variable">$&#123;node&#125;</span> because it is not x86_64&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">show_help</span></span>() &#123;</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">Usage: $0 [OPTIONS]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Options:</span></span><br><span class="line"><span class="string">    -s, --enable-spdk           Enable checking SPDK prerequisites</span></span><br><span class="line"><span class="string">    -p, --expected-nr-hugepages Expected number of 2 MiB hugepages for SPDK. Default: 1024</span></span><br><span class="line"><span class="string">    -h, --help                  Show this help message and exit</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enable_spdk=<span class="literal">false</span></span><br><span class="line">expected_nr_hugepages=1024</span><br><span class="line"><span class="keyword">while</span> [[ <span class="variable">$#</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">    opt=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">        -s|--enable-spdk)</span><br><span class="line">            enable_spdk=<span class="literal">true</span></span><br><span class="line">            ;;</span><br><span class="line">        -p|--expected-nr-hugepages)</span><br><span class="line">            expected_nr_hugepages=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="built_in">shift</span></span><br><span class="line">            ;;</span><br><span class="line">        -h|--<span class="built_in">help</span>)</span><br><span class="line">            show_help</span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            instance_manager_options+=(<span class="string">&quot;<span class="variable">$1</span>&quot;</span>)</span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line"><span class="comment"># Main logics</span></span><br><span class="line"><span class="comment">######################################################</span></span><br><span class="line">DEPENDENCIES=(<span class="string">&quot;kubectl&quot;</span> <span class="string">&quot;jq&quot;</span> <span class="string">&quot;mktemp&quot;</span> <span class="string">&quot;sort&quot;</span> <span class="string">&quot;printf&quot;</span>)</span><br><span class="line">check_local_dependencies <span class="string">&quot;<span class="variable">$&#123;DEPENDENCIES[@]&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check the each host has a unique hostname (for RWX volume)</span></span><br><span class="line">check_hostname_uniqueness</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a daemonset for checking the requirements in each node</span></span><br><span class="line">TEMP_DIR=$(<span class="built_in">mktemp</span> -d)</span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> cleanup EXIT</span><br><span class="line">create_ds</span><br><span class="line">wait_ds_ready</span><br><span class="line"></span><br><span class="line">check_mount_propagation</span><br><span class="line">check_nodes <span class="string">&quot;kernel release&quot;</span> check_kernel_release</span><br><span class="line">check_nodes <span class="string">&quot;iscsid&quot;</span> check_iscsid</span><br><span class="line">check_nodes <span class="string">&quot;multipathd&quot;</span> check_multipathd</span><br><span class="line">check_nodes <span class="string">&quot;packages&quot;</span> check_packages</span><br><span class="line">check_nodes <span class="string">&quot;nfs client&quot;</span> check_nfs_client</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$enable_spdk</span>&quot;</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  check_nodes <span class="string">&quot;x86-64 SSE4.2 instruction set&quot;</span> check_sse42_support</span><br><span class="line">  check_nodes <span class="string">&quot;kernel module nvme_tcp&quot;</span> check_kernel_module CONFIG_NVME_TCP nvme_tcp</span><br><span class="line">  check_nodes <span class="string">&quot;kernel module uio_pci_generic&quot;</span> check_kernel_module CONFIG_UIO_PCI_GENERIC uio_pci_generic</span><br><span class="line">  check_nodes <span class="string">&quot;hugepage&quot;</span> check_hugepage <span class="variable">$&#123;expected_nr_hugepages&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å½“å‰æ”¯æŒ<a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.7.0/deploy/install/install-with-rancher/">Racher</a> ã€<a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.7.0/deploy/install/install-with-kubectl/">Kubectl</a>ã€<a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.7.0/deploy/install/install-with-helm/">Helm</a>å®‰è£…ï¼Œæœ¬æ–‡æ¡£é‡‡ç”¨Helmå®‰è£…</p>
<ol>
<li><p>æ·»åŠ Helmä»“åº“</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add longhorn https://charts.longhorn.io</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½åŒ…</span></span><br><span class="line">helm fetch longhorn/longhorn</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹åŒ…</span></span><br><span class="line">tar xf longhorn-1.7.0.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…å»å®˜ç½‘ä¸‹è½½tgzåŒ…</span></span><br><span class="line"><span class="comment"># https://github.com/longhorn/longhorn/releases/tag/v1.7.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é…ç½®</p>
</li>
</ol>
<ul>
<li>values.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># çœ‹éœ€æ±‚è®¾ç½®æ˜¯å¦ä¸ºé»˜è®¤storageclassï¼ˆdefaultClassï¼‰ï¼Œä¿®æ”¹pvcç­–ç•¥ä¸ºRetain</span></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">defaultClass:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">defaultFsType:</span> <span class="string">ext4</span></span><br><span class="line">  <span class="attr">defaultMkfsParams:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">defaultClassReplicaCount:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">defaultDataLocality:</span> <span class="string">disabled</span> <span class="comment"># best-effort otherwise</span></span><br><span class="line">  <span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">migratable:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">recurringJobSelector:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">jobList:</span> []</span><br><span class="line">  <span class="attr">backingImage:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">~</span></span><br><span class="line">    <span class="attr">dataSourceType:</span> <span class="string">~</span></span><br><span class="line">    <span class="attr">dataSourceParameters:</span> <span class="string">~</span></span><br><span class="line">    <span class="attr">expectedChecksum:</span> <span class="string">~</span></span><br><span class="line">  <span class="attr">defaultNodeSelector:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span> <span class="comment"># disable by default</span></span><br><span class="line">    <span class="attr">selector:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">removeSnapshotsDuringFilesystemTrim:</span> <span class="string">ignored</span> <span class="comment"># &quot;enabled&quot; or &quot;disabled&quot; otherwise</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®longhornæŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è·¯å¾„ï¼Œ/data/longhorn</span></span><br><span class="line"><span class="attr">defaultSettings:</span></span><br><span class="line">  <span class="attr">backupTarget:</span> <span class="string">~</span></span><br><span class="line">  <span class="attr">backupTargetCredentialSecret:</span> <span class="string">~</span></span><br><span class="line">  <span class="attr">allowRecurringJobWhileVolumeDetached:</span> <span class="string">~</span></span><br><span class="line">  <span class="attr">createDefaultDiskLabeledNodes:</span> <span class="string">~</span></span><br><span class="line">  <span class="attr">defaultDataPath:</span> <span class="string">/data/longhorn</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># ä¿®æ”¹uiç•Œé¢çš„serviceç±»å‹ä¸ºNodePort</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">ui:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">manager:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">loadBalancerIP:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">loadBalancerSourceRanges:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨çº¿éƒ¨ç½²å‘½ä»¤</span></span><br><span class="line">helm install longhorn longhorn/longhorn --namespace longhorn-system --create-namespace -f ./values.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦»çº¿ç¯å¢ƒå®‰è£…å‘½ä»¤ï¼Œè¿›å…¥åˆ°longhornçš„helmç›®å½•ä¸‹</span></span><br><span class="line">helm install longhorn  --namespace longhorn-system --create-namespace -f ./</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹"><a href="#æŸ¥çœ‹" class="headerlink" title="æŸ¥çœ‹"></a>æŸ¥çœ‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n longhorn-system</span><br><span class="line"></span><br><span class="line"><span class="comment">###############PS:LOG################################</span></span><br><span class="line">(base) [root@node77 longhorn]# kubectl get all -n longhorn-system</span><br><span class="line">NAME                                                    READY   STATUS    RESTARTS       AGE</span><br><span class="line">pod/csi-attacher-54946dbcb8-88kmf                       1/1     Running   2 (27h ago)    4d1h</span><br><span class="line">pod/csi-attacher-54946dbcb8-frz87                       1/1     Running   1              4d1h</span><br><span class="line">pod/csi-attacher-54946dbcb8-pc2c2                       1/1     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/csi-provisioner-7b64855c94-2ns99                    1/1     Running   2 (27h ago)    4d1h</span><br><span class="line">pod/csi-provisioner-7b64855c94-dssvx                    1/1     Running   2 (4d1h ago)   4d1h</span><br><span class="line">pod/csi-provisioner-7b64855c94-vr5ms                    1/1     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/csi-resizer-8b4b94dcd-lg5t4                         1/1     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/csi-resizer-8b4b94dcd-sc6r9                         1/1     Running   2 (27h ago)    4d1h</span><br><span class="line">pod/csi-resizer-8b4b94dcd-zsd7t                         1/1     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/csi-snapshotter-5847d4c879-mkmsp                    1/1     Running   0              4d1h</span><br><span class="line">pod/csi-snapshotter-5847d4c879-qxhxc                    1/1     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/csi-snapshotter-5847d4c879-t5nh5                    1/1     Running   1 (27h ago)    4d1h</span><br><span class="line">pod/engine-image-ei-b0369a5d-g6jnc                      1/1     Running   1 (27h ago)    32h</span><br><span class="line">pod/engine-image-ei-b0369a5d-n6hjh                      1/1     Running   3 (27h ago)    4d1h</span><br><span class="line">pod/engine-image-ei-b0369a5d-v5qw7                      1/1     Running   1 (27h ago)    4d1h</span><br><span class="line">pod/instance-manager-01b254fdf9643d3bc7715d8ad0beeeef   1/1     Running   0              27h</span><br><span class="line">pod/instance-manager-0eab76db8dc7fc6ffb02464073dcd3b7   1/1     Running   0              27h</span><br><span class="line">pod/instance-manager-65b907de8eac2c4029e4abf9b53b17c4   1/1     Running   0              27h</span><br><span class="line">pod/longhorn-csi-plugin-6q74l                           3/3     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/longhorn-csi-plugin-dg825                           3/3     Running   1              4d1h</span><br><span class="line">pod/longhorn-csi-plugin-qsnzn                           3/3     Running   0              32h</span><br><span class="line">pod/longhorn-driver-deployer-68cb9bf546-x5ls7           1/1     Running   1              4d1h</span><br><span class="line">pod/longhorn-manager-6rtxm                              1/1     Running   1 (4d1h ago)   4d1h</span><br><span class="line">pod/longhorn-manager-f9dll                              1/1     Running   1              4d1h</span><br><span class="line">pod/longhorn-manager-trp7k                              1/1     Running   0              32h</span><br><span class="line">pod/longhorn-ui-5db87b4db5-2h8gk                        1/1     Running   0              4d1h</span><br><span class="line">pod/longhorn-ui-5db87b4db5-6p9vq                        1/1     Running   0              4d1h</span><br><span class="line"></span><br><span class="line">NAME                                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/longhorn-admission-webhook    ClusterIP   10.96.0.169   &lt;none&gt;        9502/TCP       4d1h</span><br><span class="line">service/longhorn-backend              ClusterIP   10.96.0.91    &lt;none&gt;        9500/TCP       4d1h</span><br><span class="line">service/longhorn-conversion-webhook   ClusterIP   10.96.0.89    &lt;none&gt;        9501/TCP       4d1h</span><br><span class="line">service/longhorn-engine-manager       ClusterIP   None          &lt;none&gt;        &lt;none&gt;         4d1h</span><br><span class="line">service/longhorn-frontend             NodePort    10.96.0.249   &lt;none&gt;        80:32601/TCP   4d1h</span><br><span class="line">service/longhorn-recovery-backend     ClusterIP   10.96.1.207   &lt;none&gt;        9503/TCP       4d1h</span><br><span class="line">service/longhorn-replica-manager      ClusterIP   None          &lt;none&gt;        &lt;none&gt;         4d1h</span><br><span class="line"></span><br><span class="line">NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/engine-image-ei-b0369a5d   3         3         3       3            3           &lt;none&gt;          4d1h</span><br><span class="line">daemonset.apps/longhorn-csi-plugin        3         3         3       3            3           &lt;none&gt;          4d1h</span><br><span class="line">daemonset.apps/longhorn-manager           3         3         3       3            3           &lt;none&gt;          4d1h</span><br><span class="line"></span><br><span class="line">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/csi-attacher               3/3     3            3           4d1h</span><br><span class="line">deployment.apps/csi-provisioner            3/3     3            3           4d1h</span><br><span class="line">deployment.apps/csi-resizer                3/3     3            3           4d1h</span><br><span class="line">deployment.apps/csi-snapshotter            3/3     3            3           4d1h</span><br><span class="line">deployment.apps/longhorn-driver-deployer   1/1     1            1           4d1h</span><br><span class="line">deployment.apps/longhorn-ui                2/2     2            2           4d1h</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/csi-attacher-54946dbcb8               3         3         3       4d1h</span><br><span class="line">replicaset.apps/csi-provisioner-7b64855c94            3         3         3       4d1h</span><br><span class="line">replicaset.apps/csi-resizer-8b4b94dcd                 3         3         3       4d1h</span><br><span class="line">replicaset.apps/csi-snapshotter-5847d4c879            3         3         3       4d1h</span><br><span class="line">replicaset.apps/longhorn-driver-deployer-68cb9bf546   1         1         1       4d1h</span><br><span class="line">replicaset.apps/longhorn-ui-5db87b4db5                2         2         2       4d1h</span><br><span class="line"></span><br><span class="line">NAME               COMPLETIONS   DURATION   AGE</span><br><span class="line">job.batch/kbench   0/1           4d1h       4d1h</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•å®‰è£…"><a href="#æµ‹è¯•å®‰è£…" class="headerlink" title="æµ‹è¯•å®‰è£…"></a>æµ‹è¯•å®‰è£…</h2><h3 id="æµ‹è¯•è¯´æ˜"><a href="#æµ‹è¯•è¯´æ˜" class="headerlink" title="æµ‹è¯•è¯´æ˜"></a>æµ‹è¯•è¯´æ˜</h3><p>åŸºäº<a target="_blank" rel="noopener" href="https://github.com/yasker/kbench">https://github.com/yasker/kbench</a>é¡¹ç›®è¿›è¡Œæ€§èƒ½æµ‹è¯•<br>å¯¹äºå®˜æ–¹åŸºå‡†æµ‹è¯•ï¼š</p>
<ol>
<li>SIZEç¯å¢ƒå˜é‡ï¼šå¤§å°åº”è‡³å°‘ä¸º<strong>è¯»&#x2F;å†™å¸¦å®½çš„ 25 å€</strong>ï¼Œä»¥é¿å…ç¼“å­˜å½±å“ç»“æœã€‚</li>
<li>å¦‚æœè¦æµ‹è¯•åƒ Longhorn è¿™æ ·çš„åˆ†å¸ƒå¼å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œè¯·<strong>å§‹ç»ˆé¦–å…ˆé’ˆå¯¹æœ¬åœ°å­˜å‚¨è¿›è¡Œæµ‹è¯•</strong>ï¼Œä»¥äº†è§£åŸºçº¿æ˜¯ä»€ä¹ˆã€‚<ul>
<li>å¦‚æœæ‚¨ä½¿ç”¨ Kubernetes è¿›è¡Œæµ‹è¯•ï¼Œåˆ™å¯ä»¥ä¸ºæœ¬åœ°å­˜å‚¨å®‰è£…å­˜å‚¨æä¾›ç¨‹åºï¼Œä¾‹å¦‚<a target="_blank" rel="noopener" href="https://github.com/rancher/local-path-provisioner">æœ¬åœ°è·¯å¾„é…ç½®å™¨</a>ï¼Œç”¨äºæ­¤æµ‹è¯•ã€‚</li>
</ul>
</li>
<li>CPU_IDLE_PROFç¯å¢ƒå˜é‡ï¼šCPU ç©ºé—²åº¦åˆ†ææµ‹é‡ CPU ç©ºé—²ï¼Œä½†å®ƒä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€å¹¶é™ä½å­˜å‚¨æ€§èƒ½ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥æ ‡å¿—å¤„äºç¦ç”¨çŠ¶æ€ã€‚</li>
</ol>
<h3 id="å‚æ•°è§£æ"><a href="#å‚æ•°è§£æ" class="headerlink" title="å‚æ•°è§£æ"></a>å‚æ•°è§£æ</h3><ul>
<li><strong>IOPS</strong>ï¼šæ¯ç§’ IO æ“ä½œæ•°ã€‚<em>è¶Šé«˜è¶Šå¥½ã€‚</em><ul>
<li>å®ƒæ˜¯è¡¡é‡è®¾å¤‡åœ¨ä¸€ç§’é’Ÿå†…å¯ä»¥å¤„ç†å¤šå°‘ IO æ“ä½œçš„åº¦é‡ï¼Œä¸»è¦æ¶‰åŠè¾ƒå°çš„ IO å—ï¼Œä¾‹å¦‚ 4kã€‚</li>
</ul>
</li>
<li><strong>å¸¦å®½</strong>ï¼šä¹Ÿç§°ä¸º<strong>ååé‡</strong>ã€‚<em>è¶Šé«˜è¶Šå¥½ã€‚</em><ul>
<li>å®ƒæ˜¯è®¾å¤‡åœ¨ä¸€ç§’é’Ÿå†…å¯ä»¥è¯»å–&#x2F;å†™å…¥å¤šå°‘æ•°æ®çš„åº¦é‡ã€‚å®ƒä¸»è¦æ˜¯å¤„ç†è¾ƒå¤§çš„IOå—ï¼Œä¾‹å¦‚128kã€‚</li>
</ul>
</li>
<li><strong>å»¶è¿Ÿ</strong>ï¼šæ¯ä¸ªè¯·æ±‚åœ¨ IO è·¯å¾„ä¸­èŠ±è´¹çš„æ€»æ—¶é—´ã€‚è¶Š_ä½è¶Šå¥½ã€‚_<ul>
<li>å®ƒæ˜¯å­˜å‚¨ç³»ç»Ÿå¤„ç†æ¯ä¸ªè¯·æ±‚çš„æ•ˆç‡çš„åº¦é‡ã€‚</li>
<li>å­˜å‚¨ç³»ç»Ÿçš„æ•°æ®è·¯å¾„å¼€é”€å¯ä»¥è¡¨ç¤ºä¸ºå®ƒåœ¨æœ¬æœºå­˜å‚¨ç³»ç»Ÿ ï¼ˆSSD&#x2F;NVMeï¼‰ ä¹‹ä¸Šå¢åŠ çš„å»¶è¿Ÿã€‚</li>
</ul>
</li>
<li>CPU ç©ºé—²ï¼šè¿è¡Œæµ‹è¯•çš„èŠ‚ç‚¹ä¸Šçš„ <strong>CPU ç©ºé—²</strong>ç¨‹åº¦ã€‚<em>è¶Šé«˜è¶Šå¥½ã€‚</em><ul>
<li>å®ƒæ˜¯å­˜å‚¨è®¾å¤‡ç”Ÿæˆçš„ CPU è´Ÿè½½&#x2F;å¼€é”€çš„åº¦é‡ã€‚</li>
<li>è¯·æ³¨æ„ï¼Œè¿™æ˜¯ç©ºé—²ï¼Œå› æ­¤å¦‚æœè¯¥å€¼æ›´é«˜ï¼Œåˆ™æ„å‘³ç€è¯¥èŠ‚ç‚¹ä¸Šçš„ CPU å…·æœ‰æ›´å¤šçš„ç©ºé—²å‘¨æœŸã€‚</li>
<li>ä¸å¹¸çš„æ˜¯ï¼Œæ­¤æµ‹é‡å€¼ç›®å‰æ— æ³•åæ˜ åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿæ•´ä¸ªç¾¤é›†ä¸Šçš„è´Ÿè½½ã€‚ä½†æ˜¯ï¼Œåœ¨åŸºå‡†æµ‹è¯•æ—¶ï¼Œå®ƒä»ç„¶æ˜¯å­˜å‚¨å®¢æˆ·ç«¯çš„CPUè´Ÿè½½çš„å€¼å¾—å‚è€ƒï¼ˆå–å†³äºåˆ†å¸ƒå¼å­˜å‚¨çš„æ¶æ„æ–¹å¼ï¼‰ã€‚</li>
</ul>
</li>
<li>å¯¹äº_æ¯”è¾ƒåŸºå‡†_ï¼Œè¯¥åˆ—æŒ‡ç¤ºå°†ç¬¬äºŒä¸ªå·ä¸ç¬¬ä¸€ä¸ªå·è¿›è¡Œæ¯”è¾ƒæ—¶çš„ç™¾åˆ†æ¯”å·®å¼‚ã€‚<ul>
<li>å¯¹äº **IOPSã€å¸¦å®½ã€CPU ç©ºé—²ï¼Œ**æ­£ç™¾åˆ†æ¯”æ›´å¥½ã€‚</li>
<li>å¯¹äº<strong>å»¶è¿Ÿ</strong>ï¼Œè´Ÿç™¾åˆ†æ¯”æ›´å¥½ã€‚</li>
<li>å¯¹äº **CPU ç©ºé—²ï¼Œ**æˆ‘ä»¬æ˜¾ç¤ºçš„ä¸æ˜¯å˜åŒ–çš„ç™¾åˆ†æ¯”ï¼Œè€Œæ˜¯å·®å¼‚ã€‚</li>
</ul>
</li>
</ul>
<h3 id="äº†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„ç»“æœ"><a href="#äº†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„ç»“æœ" class="headerlink" title="äº†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„ç»“æœ"></a>äº†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„ç»“æœ</h3><p>å¯¹äºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œå§‹ç»ˆéœ€è¦å…ˆæµ‹è¯•æœ¬åœ°å­˜å‚¨ä½œä¸ºåŸºå‡†ã€‚<br>_åœ¨ä»¥ä¸‹_æƒ…å†µä¸‹å‡ºç°é—®é¢˜ï¼š</p>
<ol>
<li>è¯»å–_å»¶è¿Ÿä½äºæœ¬åœ°å­˜å‚¨_ã€‚<ul>
<li>æ‚¨å¯èƒ½ä¼šè·å¾—æ¯”æœ¬åœ°å­˜å‚¨æ›´é«˜çš„è¯»å– IOPS&#x2F;å¸¦å®½ï¼Œå› ä¸ºå­˜å‚¨å¼•æ“å¯ä»¥èšåˆæ¥è‡ªä¸åŒèŠ‚ç‚¹&#x2F;ç£ç›˜çš„æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œä¸æœ¬åœ°å­˜å‚¨ç›¸æ¯”ï¼Œæ‚¨åº”è¯¥æ— æ³•è·å¾—æ›´ä½çš„è¯»å–å»¶è¿Ÿã€‚</li>
<li>å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå¾ˆå¯èƒ½æ˜¯ç”±äºå­˜åœ¨ç¼“å­˜ã€‚å¢åŠ ä»¥é¿å…è¿™ç§æƒ…å†µã€‚SIZE</li>
</ul>
</li>
<li><em>å†™å…¥ IOPS&#x2F;å¸¦å®½&#x2F;å»¶è¿Ÿæ¯”æœ¬åœ°å­˜å‚¨æ›´å¥½</em>ã€‚<ul>
<li>ä¸åˆ†å¸ƒå¼å­˜å‚¨è§£å†³æ–¹æ¡ˆçš„æœ¬åœ°å­˜å‚¨ç›¸æ¯”ï¼Œå‡ ä¹ä¸å¯èƒ½è·å¾—æ›´å¥½çš„å†™å…¥æ€§èƒ½ï¼Œé™¤éåœ¨æœ¬åœ°å­˜å‚¨å‰é¢æœ‰ä¸€ä¸ªæŒä¹…æ€§ç¼“å­˜è®¾å¤‡ã€‚</li>
<li>å¦‚æœå¾—åˆ°æ­¤ç»“æœï¼Œåˆ™å­˜å‚¨è§£å†³æ–¹æ¡ˆå¯èƒ½ä¸æ˜¯å´©æºƒä¸€è‡´çš„ï¼Œå› æ­¤å®ƒä¸ä¼šåœ¨å“åº”ä¹‹å‰å°†æ•°æ®æäº¤åˆ°ç£ç›˜ä¸­ï¼Œè¿™æ„å‘³ç€åœ¨å‘ç”Ÿäº‹ä»¶æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ã€‚</li>
</ul>
</li>
<li>æ‚¨å°†è·å¾—å»¶è¿Ÿ_åŸºå‡†çš„ä½ CPU ç©ºé—²ç‡ï¼Œä¾‹å¦‚ <code>&lt;40%</code>ã€‚<ul>
<li>å¯¹äº<strong>å»¶è¿Ÿ</strong>ï¼ŒCPU <strong>ç©ºé—²åº”</strong>è‡³å°‘ä¸º 40%ï¼Œä»¥ç¡®ä¿æµ‹è¯•ä¸ä¼šå—åˆ° CPU ä¸è¶³çš„å½±å“ã€‚</li>
<li>å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè¯·å‘èŠ‚ç‚¹æ·»åŠ æ›´å¤š CPUï¼Œæˆ–ç§»åŠ¨åˆ°å¢å¼ºè®¡ç®—æœºã€‚</li>
</ul>
</li>
</ol>
<h3 id="éƒ¨ç½²-FIO-åŸºå‡†"><a href="#éƒ¨ç½²-FIO-åŸºå‡†" class="headerlink" title="éƒ¨ç½² FIO åŸºå‡†"></a>éƒ¨ç½² FIO åŸºå‡†</h3><h4 id="åœ¨-Kubernetes-é›†ç¾¤ä¸­éƒ¨ç½²å•å·åŸºå‡†æµ‹è¯•"><a href="#åœ¨-Kubernetes-é›†ç¾¤ä¸­éƒ¨ç½²å•å·åŸºå‡†æµ‹è¯•" class="headerlink" title="åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å•å·åŸºå‡†æµ‹è¯•"></a>åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²å•å·åŸºå‡†æµ‹è¯•</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼š</p>
<ol>
<li>åŸºå‡†æµ‹è¯•å°†ä½¿ç”¨<strong>é»˜è®¤å­˜å‚¨ç±»</strong>ã€‚<ul>
<li>æ‚¨å¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨ YAML æŒ‡å®šå­˜å‚¨ç±»ã€‚</li>
</ul>
</li>
<li>å°†ä½¿ç”¨<strong>æ–‡ä»¶ç³»ç»Ÿæ¨¡å¼</strong>ã€‚<ul>
<li>æ‚¨å¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨ YAML åˆ‡æ¢åˆ°é˜»æ­¢æ¨¡å¼ã€‚</li>
</ul>
</li>
<li>è¯¥æµ‹è¯•æš‚æ—¶éœ€è¦ <strong>33G</strong> PVCã€‚<ul>
<li>å¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨ YAML æ›´æ”¹æµ‹è¯•å¤§å°ã€‚</li>
<li>å¦‚ä¸Šæ‰€è¿°ï¼Œå¯¹äºæ­£å¼åŸºå‡†æµ‹è¯•ï¼Œå¤§å°åº”<strong>è‡³å°‘ä¸ºè¯»&#x2F;å†™å¸¦å®½çš„ 25 å€</strong>ï¼Œä»¥é¿å…ç¼“å­˜å½±å“ç»“æœã€‚</li>
</ul>
</li>
</ol>
<h3 id="æµ‹è¯•æ­¥éª¤"><a href="#æµ‹è¯•æ­¥éª¤" class="headerlink" title="æµ‹è¯•æ­¥éª¤"></a>æµ‹è¯•æ­¥éª¤</h3><h4 id="LonghornåŸºå‡†æµ‹è¯•"><a href="#LonghornåŸºå‡†æµ‹è¯•" class="headerlink" title="LonghornåŸºå‡†æµ‹è¯•"></a>LonghornåŸºå‡†æµ‹è¯•</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/yasker/kbench/main/deploy/fio.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kbench-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">33Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kbench</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">kbench:</span> <span class="string">fio</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kbench</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">yasker/kbench:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FILE_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/volume/test&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SIZE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;30G&quot;</span> <span class="comment"># must be 10% smaller than the PVC size due to filesystem also took space</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CPU_IDLE_PROF</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;disabled&quot;</span> <span class="comment"># must be &quot;enabled&quot; or &quot;disabled&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/volume/</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">kbench-pvc</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="ç»“æœå±•ç¤º"><a href="#ç»“æœå±•ç¤º" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(base) [root@node77 longhorn]# kubectl logs -f kbench-msz5k</span><br><span class="line">TEST_FILE: /volume/test</span><br><span class="line">TEST_OUTPUT_PREFIX: test_device</span><br><span class="line">TEST_SIZE: 30G</span><br><span class="line">Benchmarking iops.fio into test_device-iops.json</span><br><span class="line">fio: pid=0, err=30/file:filesetup.c:224, func=write, error=Read-only file system</span><br><span class="line">fio: io_u error on file /volume/test: Read-only file system: <span class="built_in">read</span> offset=0, buflen=4096</span><br></pre></td></tr></table></figure>


<h2 id="å¸è½½æ­¥éª¤"><a href="#å¸è½½æ­¥éª¤" class="headerlink" title="å¸è½½æ­¥éª¤"></a>å¸è½½æ­¥éª¤</h2><p><strong>æ³¨æ„ï¼šå¸è½½å‰æœ€å¥½å°†æ‰€æœ‰pvcåŠpvéƒ½é€ä¸ªåˆ é™¤</strong></p>
<h3 id="åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼ä¸€ï¼Œç»ˆç«¯"><a href="#åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼ä¸€ï¼Œç»ˆç«¯" class="headerlink" title="åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼ä¸€ï¼Œç»ˆç«¯"></a>åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼ä¸€ï¼Œç»ˆç«¯</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">-n</span> <span class="string">longhorn-system</span> <span class="string">patch</span> <span class="string">-p</span> <span class="string">&#x27;&#123;&quot;value&quot;: &quot;true&quot;&#125;&#x27;</span> <span class="string">--type=merge</span> <span class="string">lhs</span> <span class="string">deleting-confirmation-flag</span></span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼äºŒï¼Œç•Œé¢"><a href="#åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼äºŒï¼Œç•Œé¢" class="headerlink" title="åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼äºŒï¼Œç•Œé¢"></a>åˆ é™¤æ ‡å¿—è®¾ç½®ï¼šæ–¹å¼äºŒï¼Œç•Œé¢</h3><ul>
<li>å‹¾é€‰<strong>Deleting Confirmation Flagé€‰é¡¹</strong><br><a href="/images/14-longhorn_delete.png" title="longhorn" class="gallery-item" style="box-shadow: none;"> <img src="/images/14-longhorn_delete.png" alt="longhorn"></a></li>
</ul>
<h3 id="åˆ é™¤æ“ä½œ"><a href="#åˆ é™¤æ“ä½œ" class="headerlink" title="åˆ é™¤æ“ä½œ"></a>åˆ é™¤æ“ä½œ</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">helm</span> <span class="string">uninstall</span> <span class="string">longhorn</span> <span class="string">-n</span> <span class="string">longhorn-system</span></span><br></pre></td></tr></table></figure>



<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol>
<li><h2 id="å®‰è£…iscsi-initiator-utilsæŠ¥é”™"><a href="#å®‰è£…iscsi-initiator-utilsæŠ¥é”™" class="headerlink" title="å®‰è£…iscsi-initiator-utilsæŠ¥é”™"></a>å®‰è£…iscsi-initiator-utilsæŠ¥é”™</h2><ul>
<li>æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</li>
</ul>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http://mirrors.bfsu.edu.cn/centos/7.9.2009/updates/x86_64/Packages/iscsi-initiator-utils-iscsiuio-6.2.0.874-22.el7_9.x86_64.rpm: [Errno 14] HTTP Error 404 - Not Found--:-- ETA </span><br><span class="line">Trying other mirror.</span><br><span class="line">iscsi-initiator-utils-6.2.0.87 FAILED                                          </span><br><span class="line">http://mirrors.huaweicloud.com/centos/7.9.2009/updates/x86_64/Packages/iscsi-initiator-utils-6.2.0.874-22.el7_9.x86_64.rpm: [Errno 14] HTTP Error 404 - Not Found  --:--:-- ETA </span><br><span class="line">Trying other mirror.</span><br><span class="line">iscsi-initiator-utils-iscsiuio FAILED                                          </span><br><span class="line">http://mirrors.163.com/centos/7.9.2009/updates/x86_64/Packages/iscsi-initiator-utils-iscsiuio-6.2.0.874-22.el7_9.x86_64.rpm: [Errno 14] HTTP Error 404 - Not Found --:--:-- ETA </span><br><span class="line">Trying other mirror.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Error downloading packages:</span><br><span class="line">  iscsi-initiator-utils-6.2.0.874-22.el7_9.x86_64: [Errno 256] No more mirrors to try.</span><br><span class="line">  iscsi-initiator-utils-iscsiuio-6.2.0.874-22.el7_9.x86_64: [Errno 256] No more mirrors to try.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>è§£å†³æ–¹æ¡ˆï¼š<ul>
<li>æ›´æ¢yum.repo.d&#x2F;Centos.Base.repo</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS-Base.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The mirror system uses the connecting IP address of the client and the</span></span><br><span class="line"><span class="comment"># update status of each mirror to pick mirrors that are updated to and</span></span><br><span class="line"><span class="comment"># geographically close to the client.  You should use this for CentOS updates</span></span><br><span class="line"><span class="comment"># unless you are manually picking other mirrors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If the mirrorlist= does not work for you, as a fall back you can try the </span></span><br><span class="line"><span class="comment"># remarked out baseurl= line instead.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[base]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Base - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#released updates </span></span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Updates - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos/<span class="variable">$releasever</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos/<span class="variable">$releasever</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos/<span class="variable">$releasever</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that may be useful</span></span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Extras - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos/<span class="variable">$releasever</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos/<span class="variable">$releasever</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos/<span class="variable">$releasever</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Plus - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos/<span class="variable">$releasever</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos/<span class="variable">$releasever</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos/<span class="variable">$releasever</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#contrib - packages by Centos Users</span></span><br><span class="line">[contrib]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Contrib - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos/<span class="variable">$releasever</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos/<span class="variable">$releasever</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos/<span class="variable">$releasever</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br></pre></td></tr></table></figure>

<ul>
<li>æ›´æ¢åå†æ‰§è¡Œå®‰è£…å‘½ä»¤</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install iscsi-initiator-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#################op log#############################</span></span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Installing : iscsi-initiator-utils-iscsiuio-6.2.0.874-22.el7_9.x86_64              1/2 </span><br><span class="line">  Installing : iscsi-initiator-utils-6.2.0.874-22.el7_9.x86_64                       2/2 </span><br><span class="line">  Verifying  : iscsi-initiator-utils-6.2.0.874-22.el7_9.x86_64                       1/2 </span><br><span class="line">  Verifying  : iscsi-initiator-utils-iscsiuio-6.2.0.874-22.el7_9.x86_64              2/2 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  iscsi-initiator-utils.x86_64 0:6.2.0.874-22.el7_9                                      </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  iscsi-initiator-utils-iscsiuio.x86_64 0:6.2.0.874-22.el7_9    </span><br></pre></td></tr></table></figure>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-03-06</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« sswfive</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/K8S/'>
                            K8S
                        </a>
                    
                        <a href='/tags/%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6/'>
                            å­˜å‚¨ç»„ä»¶
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/'>
                            äº‘åŸç”Ÿ
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>ä¸Šä¸€ç¯‡ï¼š<a href='/2025/03/06/15-ktconnect/'>å¼€å‘å·¥å…·ä¹‹KtConnectçš„ä½¿ç”¨</a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2025/03/06/13-helm/">åŒ…ç®¡ç†å·¥å…·Helmçš„ä½¿ç”¨</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 2019ï½2025 China 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠçœ‹è¿‡å¤§æµ·çš„äººä¸ä¼šå¿˜è®°æµ·çš„å¹¿é˜”ğŸŒŠ</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
            
    </body>
</html>